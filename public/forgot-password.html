<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forgot Password | Govt of Bangladesh</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>

<body>
    <div class="bg-shape shape-1"></div>
    <div class="bg-shape shape-2"></div>

    <div class="container">
        <div class="auth-card">
            <div class="logo-area">
                <i class="fas fa-lock-open fa-3x" style="color: white; margin-bottom: 10px;"></i>
                <h1>Reset Password</h1>
                <p>2-Step Verification</p>
            </div>

            <div id="alertBox" class="alert"></div>

            <!-- Step 1: Request OTP -->
            <form id="step1Form">
                <div class="form-group">
                    <label for="email">Email Address</label>
                    <input type="email" id="email" class="form-control" placeholder="citizen@bangladesh.gov.bd"
                        required>
                </div>
                <div class="form-group">
                    <label for="nid">NID Number</label>
                    <input type="text" id="nid" class="form-control" placeholder="National ID Number" required>
                </div>
                <button type="submit" class="btn-primary">Send Secret Code</button>
            </form>

            <!-- Step 2: Verify & Reset (Hidden initially) -->
            <form id="step2Form" style="display: none;">
                <div class="form-group">
                    <label for="otp">Secret Code (OTP)</label>
                    <input type="text" id="otp" class="form-control" placeholder="6-digit code from email" required>
                </div>
                <div class="form-group">
                    <label for="newPassword">New Password</label>
                    <input type="password" id="newPassword" class="form-control" placeholder="New secure password"
                        required>
                </div>
                <button type="submit" class="btn-primary">Verify & Change Password</button>
            </form>

            <div class="auth-links">
                <a href="index.html">Back to Login</a>
            </div>
        </div>
    </div>

    <script src="js/auth.js"></script>
    <script>
        const step1Form = document.getElementById('step1Form');
        const step2Form = document.getElementById('step2Form');

        let userEmail = '';
        let userNid = '';

        step1Form.addEventListener('submit', async (e) => {
            e.preventDefault();
            userEmail = document.getElementById('email').value;
            userNid = document.getElementById('nid').value;

            Swal.showLoading();

            try {
                const res = await fetch('/api/auth/send-reset-otp', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: userEmail, nid: userNid })
                });
                const data = await res.json();
                Swal.close();

                if (res.ok) {
                    let htmlText = 'Code sent to your email.';
                    if (data.previewUrl) {
                        htmlText += `<br><br><a href="${data.previewUrl}" target="_blank" style="color:#f42a41;font-weight:bold;">[CLICK HERE for OTP]</a>`;
                    }

                    Swal.fire({
                        icon: 'success',
                        title: 'Code Sent!',
                        html: htmlText,
                        background: '#0f172a',
                        color: '#fff'
                    });

                    step1Form.style.display = 'none';
                    step2Form.style.display = 'block';
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: data.error || 'Failed to send code',
                        background: '#0f172a',
                        color: '#fff'
                    });
                }
            } catch (err) {
                Swal.fire({ icon: 'error', title: 'Network Error', background: '#0f172a', color: '#fff' });
            }
        });

        step2Form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const otp = document.getElementById('otp').value;
            const newPassword = document.getElementById('newPassword').value;

            Swal.showLoading();

            try {
                const res = await fetch('/api/auth/reset-password-verify', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: userEmail, nid: userNid, otp, newPassword })
                });
                const data = await res.json();
                Swal.close();

                if (res.ok) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Success!',
                        text: 'Password Changed. Please login.',
                        background: '#006a4e',
                        color: '#fff'
                    }).then(() => {
                        window.location.href = 'index.html';
                    });
                } else {
                    const msg = data.errors ? data.errors.map(e => e.msg).join('\n') : (data.error || 'Reset failed');
                    Swal.fire({
                        icon: 'error',
                        title: 'Verification Failed',
                        text: msg,
                        background: '#0f172a',
                        color: '#fff'
                    });
                }
            } catch (err) {
                Swal.fire({ icon: 'error', title: 'Network Error', background: '#0f172a', color: '#fff' });
            }
        });
    </script>
</body>

</html>